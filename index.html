<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Store Map</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.4.0/mapbox-gl.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.4.0/mapbox-gl.js"></script>
    <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.1.0/mapbox-gl-geocoder.min.js"></script>
    <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.1.0/mapbox-gl-geocoder.css" type="text/css">
    
    <style>
        body, html { margin: 0; padding: 0; height: 100%; font-family: sans-serif; overflow: hidden; box-sizing: border-box; }
        #map-container { width: 100%; height: 100%; display: flex; flex-direction: row; }
        #map { flex-grow: 1; position: relative; }
        #store-list-container { width: 350px; display: flex; flex-direction: column; border-left: 1px solid #ccc; background-color: #f9f9f9; }
        #country-filter-container { padding: 20px; border-bottom: 1px solid #ccc; }
        #country-select { width: 100%; padding: 8px; font-size: 1em; border: 1px solid #ccc; border-radius: 4px; }
        #store-list { overflow-y: auto; padding: 20px; flex-grow: 1; }
        .store-item { display: flex; align-items: center; padding: 15px; border-bottom: 1px solid #eee; cursor: pointer; transition: background-color 0.2s ease-in-out; border-radius: 5px; margin-bottom: 10px; }
        .store-item:hover, .store-item.highlighted { background-color: #e6f7ff; }
        .store-counter { width: 30px; height: 30px; background-color: #2dabe8; color: white; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-weight: bold; font-size: 1em; margin-right: 15px; flex-shrink: 0; }
        .store-details { flex-grow: 1; }
        .store-details h3 { margin: 0 0 5px; font-size: 1.2em; color: #333; }
        .store-details p { margin: 0; font-size: 0.9em; color: #666; }
        .store-button { display: inline-block; margin-top: 10px; padding: 8px 12px; background-color: #2dabe8; color: white; text-decoration: none; border-radius: 4px; font-size: 0.9em; transition: background-color 0.2s ease-in-out; }
        .store-button:hover { background-color: #1a8fbe; }
        .mapboxgl-popup-content { padding: 10px; font-family: sans-serif; }
        .mapboxgl-popup-content h3 { margin-top: 0; margin-bottom: 5px; color: #2dabe8; }
        .mapboxgl-popup-content p { margin: 0 0 5px; font-size: 0.9em; line-height: 1.3; }
        .mapboxgl-popup-content .store-button { margin-top: 5px; }
        .mapboxgl-ctrl-geocoder { position: absolute; top: 10px; left: 10px; z-index: 1; width: 300px; }
        
        /* Styles for clusters */
        .cluster-marker { width: 40px; height: 40px; background-color: #2dabe8; color: white; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-weight: bold; font-size: 1.2em; cursor: pointer; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3); }

        @media (max-width: 768px) {
            #map-container { flex-direction: column; height: 100vh; }
            #map { height: 40vh; }
            #store-list-container { width: 100%; height: 60vh; border-left: none; border-top: 1px solid #ccc; }
            #store-list { padding: 15px 0; }
            #country-filter-container { padding: 15px 15px 5px; }
            .mapboxgl-ctrl-geocoder { width: calc(100% - 20px); top: 10px; left: 10px; }
        }
    </style>
</head>
<body>
    <div id="map-container">
        <div id="map"></div>
        <div id="store-list-container">
            <div id="country-filter-container">
                <label for="country-select">Select a country:</label>
                <select id="country-select">
                    <option value="all">All countries</option>
                </select>
            </div>
            <div id="store-list"></div>
        </div>
    </div>
    <script>
        mapboxgl.accessToken = 'pk.eyJ1IjoiY3JlYXNpdG9saW5lIiwiYSI6ImNtZTMwbGdqdDAyMTcybHNiOW1idzZ5M2UifQ.74v3E1-dl8CK2Pm2N8Y0oQ';
        
        let allStores;
        let currentStores;

        const map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/streets-v12',
            center: [8.8018, 46.2227], // Initial map center
            zoom: 7
        });
        
        const geocoder = new MapboxGeocoder({
            accessToken: mapboxgl.accessToken,
            mapboxgl: mapboxgl,
            placeholder: 'Search for address or city...',
            language: 'en',
            marker: false
        });
        map.addControl(geocoder, 'top-left');

        const updateStoresData = (features) => {
            features.sort((a, b) => a.properties.name.localeCompare(b.properties.name));
            features.forEach((store, i) => {
                store.properties.index = i + 1;
            });
            return {
                'type': 'FeatureCollection',
                'features': features
            };
        };

        const flyToStore = (geometry) => { 
            map.flyTo({ 
                center: geometry.coordinates, 
                zoom: 15, 
                essential: true 
            });
            map.once('moveend', () => {
                map.resize();
            });
            setTimeout(() => {
                map.resize();
            }, 300);
        };
        
        const highlightStore = (element) => {
            document.querySelectorAll('.store-item').forEach(item => { item.classList.remove('highlighted'); });
            if (element) { element.classList.add('highlighted'); }
        };

        const highlightStoreFromMap = (properties) => {
            const storeIndex = currentStores.features.findIndex(store => 
                store.properties.name === properties.name &&
                store.properties.address === properties.address
            );
            if (storeIndex !== -1) {
                const storeItem = document.getElementById(`store-${storeIndex}`);
                if (storeItem) {
                    highlightStore(storeItem);
                    storeItem.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }
        };

        const buildStoreList = (storeFeatures) => {
            const listContainer = document.getElementById('store-list');
            listContainer.innerHTML = '';
            storeFeatures.forEach((store, index) => {
                const storeDiv = document.createElement('div');
                storeDiv.className = 'store-item';
                storeDiv.id = `store-${index}`;
                storeDiv.innerHTML = `
                    <div class="store-counter">${store.properties.index}</div>
                    <div class="store-details">
                        <h3>${store.properties.name}</h3>
                        <p>${store.properties.service}</p>
                        <p>${store.properties.address}</p>
                        <p>Phone: ${store.properties.phone}</p>
                        <a href="${store.properties.website}" target="_blank" class="store-button">Store</a>
                    </div>
                `;
                storeDiv.addEventListener('click', () => {
                    flyToStore(store.geometry);
                    highlightStore(storeDiv);
                    const popupHtml = `
                        <h3>${store.properties.name}</h3>
                        <p>${store.properties.service}</p>
                        <p>${store.properties.address}</p>
                        <p>Phone: ${store.properties.phone}</p>
                        <a href="${store.properties.website}" target="_blank" class="store-button">Store</a>
                    `;
                    new mapboxgl.Popup({ offset: 25 }).setHTML(popupHtml).setLngLat(store.geometry.coordinates).addTo(map);
                });
                listContainer.appendChild(storeDiv);
            });
        };

        const updateMap = (storeFeatures) => {
            if (map.getSource('stores')) {
                map.getSource('stores').setData(updateStoresData(storeFeatures));
            }
            buildStoreList(storeFeatures);
        };
        
        map.on('load', () => {
            fetch('stores.json')
                .then(response => response.json())
                .then(data => {
                    allStores = data;
                    currentStores = allStores;
                    
                    const countries = [...new Set(allStores.features.map(store => store.properties.country))].sort();
                    const selectElement = document.getElementById('country-select');
                    countries.forEach(country => {
                        const option = document.createElement('option');
                        option.value = country;
                        option.textContent = country;
                        selectElement.appendChild(option);
                    });

                    map.addSource('stores', {
                        type: 'geojson',
                        data: updateStoresData(allStores.features),
                        cluster: true,
                        clusterMaxZoom: 14,
                        clusterRadius: 50
                    });

                    map.addLayer({
                        id: 'clusters',
                        type: 'circle',
                        source: 'stores',
                        filter: ['has', 'point_count'],
                        paint: {
                            'circle-color': ['step', ['get', 'point_count'], '#51bbd6', 10, '#f1f075', 30, '#f28cb1'],
                            'circle-radius': ['step', ['get', 'point_count'], 20, 10, 30, 30, 40],
                            'circle-stroke-width': 1,
                            'circle-stroke-color': '#fff'
                        }
                    });

                    map.addLayer({
                        id: 'cluster-count',
                        type: 'symbol',
                        source: 'stores',
                        filter: ['has', 'point_count'],
                        layout: {
                            'text-field': ['get', 'point_count_abbreviated'],
                            'text-font': ['DIN Offc Pro Medium', 'Arial Unicode MS Bold'],
                            'text-size': 12
                        },
                        paint: { 'text-color': '#ffffff' }
                    });

                    map.addLayer({
                        id: 'unclustered-point',
                        type: 'circle',
                        source: 'stores',
                        filter: ['!', ['has', 'point_count']],
                        paint: {
                            'circle-color': '#2dabe8',
                            'circle-radius': 10,
                            'circle-stroke-width': 1,
                            'circle-stroke-color': '#fff'
                        }
                    });

                    map.addLayer({
                        id: 'unclustered-point-numbers',
                        type: 'symbol',
                        source: 'stores',
                        filter: ['!', ['has', 'point_count']],
                        layout: {
                            'text-field': ['get', 'index'],
                            'text-font': ['DIN Offc Pro Medium', 'Arial Unicode MS Bold'],
                            'text-size': 12,
                            'text-offset': [0, 0.1], 
                            'text-allow-overlap': true 
                        },
                        paint: { 'text-color': '#ffffff' }
                    });

                    map.on('click', 'clusters', (e) => {
                        const features = map.queryRenderedFeatures(e.point, { layers: ['clusters'] });
                        const clusterId = features[0].properties.cluster_id;
                        map.getSource('stores').getClusterExpansionZoom(clusterId, (err, zoom) => {
                            if (err) return;
                            map.easeTo({
                                center: features[0].geometry.coordinates,
                                zoom: zoom
                            });
                        });
                    });

                    map.on('click', 'unclustered-point', (e) => {
                        const coordinates = e.features[0].geometry.coordinates.slice();
                        const properties = e.features[0].properties;
                        const popupHtml = `
                            <h3>${properties.name}</h3>
                            <p>${properties.service}</p>
                            <p>${properties.address}</p>
                            <p>Phone: ${properties.phone}</p>
                            <a href="${properties.website}" target="_blank" class="store-button">Store</a>
                        `;
                        while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
                            coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
                        }
                        new mapboxgl.Popup({ offset: 25 }).setLngLat(coordinates).setHTML(popupHtml).addTo(map);
                        highlightStoreFromMap(properties);
                    });
                    
                    map.on('mouseenter', 'clusters', () => { map.getCanvas().style.cursor = 'pointer'; });
                    map.on('mouseleave', 'clusters', () => { map.getCanvas().style.cursor = ''; });
                    map.on('mouseenter', 'unclustered-point', () => { map.getCanvas().style.cursor = 'pointer'; });
                    map.on('mouseleave', 'unclustered-point', () => { map.getCanvas().style.cursor = ''; });

                    document.getElementById('country-select').addEventListener('change', (e) => {
                        const selectedCountry = e.target.value;
                        let filteredFeatures;
                        if (selectedCountry === 'all') {
                            filteredFeatures = allStores.features;
                            map.flyTo({ center: [8.8018, 46.2227], zoom: 7 });
                        } else {
                            filteredFeatures = allStores.features.filter(store => store.properties.country === selectedCountry);
                            if (filteredFeatures.length > 0) {
                                const firstStoreCoordinates = filteredFeatures[0].geometry.coordinates;
                                map.flyTo({ center: firstStoreCoordinates, zoom: 9 });
                            }
                        }
                        currentStores = updateStoresData(filteredFeatures);
                        updateMap(currentStores.features);
                    });
                    
                    buildStoreList(currentStores.features);
                })
                .catch(error => {
                    console.error('Error loading stores.json:', error);
                });
        });

        window.addEventListener('resize', () => { map.resize(); });
    </script>
</body>
</html>
